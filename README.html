<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Integrating Azure Key-Vault with AKS using Azure Key Vault provider for Secrets Store CSI Driver</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="integrating-azure-key-vault-with-aks-using-azure-key-vault-provider-for-secrets-store-csi-driver">Integrating Azure Key-Vault with AKS using Azure Key Vault provider for Secrets Store CSI Driver</h1>
<p>This project outlines the process of integrating Azure Key Vault with an AKS (Azure Kubernetes Service) cluster using the Azure Key Vault Provider for Secrets Store CSI Driver.</p>
<h2 id="aks-creation-and-configuration">AKS Creation and Configuration</h2>
<blockquote>
<p>Please note that all the following commands are designed for the Bash shell.</p>
</blockquote>
<p>First we need to provide the followign environemant  variables since they will be used in several occasions.</p>
<pre><code>RESOURCE_GROUP=&quot;demo-resource-group&quot;
CLUSTER_NAME=&quot;demo-cluster&quot;
KEY_VAULT_NAME=&quot;demo-key-vault-name&quot;
SUBSCRIPTION_ID=$(az account show --query id --output tsv)
</code></pre>
<p>Begin by creating an Azure resource group, which will organize the resources generated throughout this project. Adding a &quot;owner=az-cli&quot; tag helps identify resources created via the CLI.</p>
<pre><code>az group create -l eastus -n $RESOURCE_GROUP --tags &quot;owner=az-cli&quot;
</code></pre>
<p>Then we need to create an Azure Kubernetes Cluster with following specs.</p>
<ul>
<li>Free tier</li>
<li>OIDC issuer should be enabled</li>
<li>Azure Key Vault secret provider add-on should be enabled</li>
<li>Work load identity should be enabled</li>
</ul>
<p>I have utilzed the cluster creation to keep a very lowe cluster cost, so there may be additional arguments provided here. More details can be found from the official aks clustre creation <a href="https://learn.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az-aks-create">command</a>.</p>
<pre><code>az aks create --name $CLUSTER_NAME -g $RESOURCE_GROUP  --tier free --node-count 1 --node-vm-size Standard_B2s --enable-oidc-issuer  --network-plugin azure --load-balancer-sku basic --node-osdisk-size 30  --tags &quot;owner=az-cli&quot; --no-wait --enable-addons azure-keyvault-secrets-provider  --enable-workload-identity 
</code></pre>
<p>Retrieve cluster credentials and use the kubelogin plugin for cluster authentication.</p>
<pre><code>az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --overwrite-existing
</code></pre>
<pre><code>kubelogin convert-kubeconfig -l azurecli
</code></pre>
<p>Verify proper authentication with the cluster.</p>
<pre><code>kubectl get nodes

kubectl get pods -A
</code></pre>
<h2 id="azure-key-vault-creation">Azure Key Vault creation</h2>
<p>Use the following command to create an Azure Key vault.</p>
<pre><code class="language-sh">az keyvault create -n <span class="hljs-variable">$KEY_VAULT_NAME</span> -g <span class="hljs-variable">$RESOURCE_GROUP</span> -l eastus --enable-rbac-authorization
</code></pre>
<p>Create a sample secret.</p>
<pre><code>az keyvault secret set --name sample-secret --vault-name $KEY_VAULT_NAME --value sample-secret-value
</code></pre>
<p><img src="file:////home/nadeesha/repositories/private/my-devops-projects/project-3-Azure-KV-integration-with-AKS/image.png" alt="alt text"></p>
<h2 id="granting-access-to-managed-identity">Granting access to managed identity.</h2>
<p>When we create an AKS, the AKS related components are created under a <strong>separate resource group</strong> and managed identities will be created automatically with the names <code>azurekeyvaultsecretsprovider-&lt;cluster name&gt;</code> and <code>&lt;cluster name&gt;-agentpool</code>. This is not the resource group refledcted by <code>$RESOURCE_GROUP</code>.</p>
<p>We can create a separate managed idenity without using the automatically created one.</p>
<pre><code>IDENTITY_NAME=&quot;azurekeyvaultsecretsprovider-$CLUSTER_NAME&quot;

az identity create --name $IDENTITY_NAME --resource-group $RESOURCE_GROUP

</code></pre>
<p>Now this <code>azurekeyvaultsecretsprovider-&lt;cluster name&gt;</code> managed-identity needs to be configured to access the key-vault and that can be done in  several ways.</p>
<ol>
<li>Assign RBAC role to the managed-idenity to perform <code>get</code> and <code>list</code> operations in the key-vault.</li>
<li>Create key-vault access policy to the managed-idenity to perform <code>get</code> and <code>list</code> operations in the key-vault.</li>
</ol>
<p>Let's go with creating a key-vault access policy.</p>
<p>This can be done using the portal,by going to the key-vault that created above.
Then select <strong>Access policies</strong>, and create an access policy. Select <code>get</code> and <code>list</code> permissions for secrets. Now select the above created managed identity name.</p>
<p><img src="file:////home/nadeesha/repositories/private/my-devops-projects/project-3-Azure-KV-integration-with-AKS/image-1.png" alt="alt text"></p>
<h2 id="setup-federation">Setup Federation</h2>
<p>Now we need to create a trust relationship between the AKS cluster and the managed identity.</p>
<p>In order to do that we need to have</p>
<ol>
<li>Service account</li>
<li>AKS cluster OIDC issuer URL</li>
</ol>
<p>Lets obtain the AKS cluster OIDC issuer URL first.</p>
<pre><code>AKS_OIDC_ISSUER=&quot;$(az aks show --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --query &quot;oidcIssuerProfile.issuerUrl&quot; -o tsv)&quot;
</code></pre>
<p>Create a new namespace.</p>
<pre><code>NAMESPACE=&quot;kv-demo&quot;

kubectl create ns $NAMESPACE
</code></pre>
<p>Obtain the client id of the identity.</p>
<pre><code>CLIENT_ID=$(az identity show --resource-group  $RESOURCE_GROUP  --name $IDENTITY_NAME --query clientId --output tsv)

</code></pre>
<p>Now create a service account.</p>
<pre><code>SERVICE_ACCOUNT_NAME=&quot;workload-identity-sa&quot;


cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    azure.workload.identity/client-id: ${CLIENT_ID}
  name: ${SERVICE_ACCOUNT_NAME}
  namespace: ${NAMESPACE}
EOF
</code></pre>
<p>Setup the federation.</p>
<pre><code>FEDERATED_IDENTITY_NAME=&quot;aksfederatedidentity&quot;

az identity federated-credential create --name $FEDERATED_IDENTITY_NAME --identity-name $IDENTITY_NAME --resource-group $RESOURCE_GROUP --issuer ${AKS_OIDC_ISSUER} --subject system:serviceaccount:${NAMESPACE}:${SERVICE_ACCOUNT_NAME}

</code></pre>
<h2 id="create-the-secret-provider-class">Create the Secret Provider Class</h2>
<pre><code>TENANT_ID=$(az keyvault show -n $KEY_VAULT_NAME -g $RESOURCE_GROUP --query &quot;properties.tenantId&quot; -o tsv)


cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-kvname-wi
  namespace: ${NAMESPACE}
spec:
  provider: azure
  parameters:
    usePodIdentity: &quot;false&quot;
    clientID: &quot;${CLIENT_ID}&quot;                # include the client-id of the managed identity
    keyvaultName: ${KEY_VAULT_NAME}        
    cloudName: &quot;&quot;                           # [OPTIONAL for Azure] if not provided, the Azure environment defaults to AzurePublicCloud
    objects:  |
      array:
        - |
          objectName: sample-secret         # Set the name of the secret
          objectType: secret                # object types: secret, key, or cert
          objectVersion: &quot;&quot;                 # [OPTIONAL] object versions, default to latest if empty.
    tenantId: &quot;${TENANT_ID}&quot;                # The tenant ID of the key vault
EOF
</code></pre>
<h2 id="verifying-key-vault-aks-integration">Verifying Key-vault AKS integration</h2>
<p>Now a sampel pod should be created to mount the secrets.</p>
<pre><code class="language-yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">busybox-secrets-store-inline-wi</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">${NAMESPACE}</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">azure.workload.identity/use:</span> <span class="hljs-string">&quot;true&quot;</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">${SERVICE_ACCOUNT_NAME}</span>
  <span class="hljs-attr">containers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">busybox</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">registry.k8s.io/e2e-test-images/busybox:1.29-4</span>
      <span class="hljs-attr">command:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/bin/sleep&quot;</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10000&quot;</span>
      <span class="hljs-attr">volumeMounts:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secrets-store01-inline</span>
        <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/mnt/secrets-store&quot;</span>
        <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secrets-store01-inline</span>
      <span class="hljs-attr">csi:</span>
        <span class="hljs-attr">driver:</span> <span class="hljs-string">secrets-store.csi.k8s.io</span>
        <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">volumeAttributes:</span>
          <span class="hljs-attr">secretProviderClass:</span> <span class="hljs-string">&quot;azure-kvname-wi&quot;</span>
</code></pre>
<p>Now the secret will be mounted the location specified in 'mountpath'.</p>
<p>Check all the mounted components in the given path.</p>
<pre><code>kubectl exec -n $NAMESPACE busybox-secrets-store-inline-wi -- ls /mnt/secrets-store/
</code></pre>
<p>now you may see the secretname that we mentioned in the <code>SecretProviderClass</code> resource (sample-secret).</p>
<p>Verify the secret content by,</p>
<pre><code>kubectl exec -n $NAMESPACE busybox-secrets-store-inline-wi -- cat /mnt/secrets-store/sample-secret
</code></pre>
<h2 id="clean-up-the-resources">Clean up the resources</h2>
<pre><code>az aks delete --name $CLUSTER_NAME  --resource-group $RESOURCE_GROUP --no-wait
az group delete -n $RESOURCE_GROUP --no-wait
</code></pre>
<h2 id="references">References</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/cli/azure/reference-index?view=azure-cli-latest">AZ CLI documentation</a></li>
<li><a href="">Azure links with integration</a></li>
<li><a href="https://www.youtube.com/watch?v=MJ97ZInCXgY&amp;list=PLdpzxOOAlwvIcxgCUyBHVOcWs0Krjx9xR&amp;index=21&amp;pp=iAQB">Abishek weeramalla utube tutorial</a></li>
</ul>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>